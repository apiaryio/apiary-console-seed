general:
  artifacts:
    - "extension/"
    - "apiary.crx"
    - "apiary.zip"
    - "apiary_nokey.zip"

machine:
  node:
    version: 7.9.0

  hosts:
    api.xyz.com: 127.0.0.1
    console.apiary.dev: 127.0.0.1

dependencies:
  pre:
    - sudo apt-get install jq
  post:
    - echo 'NODE_ENV=CI' > .env && cd server && npm install
    - cd extension && echo $CHROME_EXTENSION_RSA_KEY > key.pem
    - cd client && echo 'NODE_ENV=CI' > .env && npm install

  cache_directories:
    - "server/node_modules"

test:
  pre:
    - npm run build:extension
    - cd server && npm start:
        background: true
    - npm start:
        background: true

  post:
    # Remove the testing 'key' field from manifest.json, because the final one will be computed by the Chrome Store.
    - jq 'del(.key)' ./extension/manifest.json > tmp.$$.json && mv tmp.$$.json ./extension/manifest.json
    - cd client && cp apiary.zip apiary_nokey.zip
    - cd client && npm run prepublish
    - cd client && zip -u apiary.zip ../extension/key.pem -j

deployment:
  production:
    branch: master
    commands:
      - npm run semantic-release || true

